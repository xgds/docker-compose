version: "3.7"
services:
  xgds:
    container_name: xgds-subsea
    image: xgds-subsea:current
    hostname: xgds-subsea
    depends_on:
      - mariadb
      - couchdb
      - redis

    # ===================================
    # if you want to develop locally,
    # uncomment the four lines below, making sure to run:
    # export XGDS_WORKING_DIRECTORY=/path/to/xgds
    # ===================================
    volumes:
      - ${XGDS_HOME_DIRECTORY}:/root
      - usr-local:/usr/local
    networks:
      - xgds-docker-net
    deploy:
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 5
        window: 60s
      placement:
        constraints:
          - node.hostname == container.xgds.org

  mariadb:
    container_name: mariadb-subsea
    image: mariadb:latest
    hostname: mariadb-subsea
    environment:
      MYSQL_ROOT_PASSWORD: xgds
      MYSQL_DATABASE: xgds_subsea
    volumes:
      - mariadb-data:/var/lib/mysql
    networks:
      - xgds-docker-net
    deploy:
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 5
        window: 60s
      placement:
        constraints:
          - node.hostname == container.xgds.org

  geoserver:
    container_name: geoserver-subsea
    image: xgds-geoserver:current
    hostname: geoserver-subsea
    volumes:
      - geoserver-data:/usr/share/geoserver/data_dir
    networks:
      - xgds-docker-net
    deploy:
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 5
        window: 60s
      placement:
        constraints:
          - node.hostname == container.xgds.org

  redis:
    container_name: redis-subsea
    image: redis:5-alpine
    hostname: redis
    expose:
      - 6379
    volumes:
      - redis-data:/data
    networks:
      - xgds-docker-net
    deploy:
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 5
        window: 60s
      placement:
        constraints:
          - node.hostname == container.xgds.org

  couchdb:
    container_name: couchdb-subsea
    image: couchdb:latest
    hostname: couchdb-subsea
    volumes:
      - type: volume
        source: couchdb-data
        target: /opt/couchdb/data
        volume:
          nocopy: false
      - type: volume
        source: couchdb-config
        target: /opt/couchdb/etc
        volume:
          nocopy: false
    networks:
      - xgds-docker-net
    deploy:
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 5
        window: 60s
      placement:
        constraints:
          - node.hostname == container.xgds.org

volumes:
  couchdb-data:
    labels:
      persistent: true
  couchdb-config:
    labels:
      persistent: true
  redis-data:
    labels:
      persistent: true
  geoserver-data:
    labels:
      persistent: true
  mariadb-data:
    labels:
      persistent: true
  usr-local:
    labels:
      persistent: true
